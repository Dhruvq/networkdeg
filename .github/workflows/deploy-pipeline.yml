name: Deploy Pipeline Branch to Port 5001

on:
  push:
    branches: [ "feat/pipeline" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Deploy Pipeline to EC2 (Port 5001)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST_DNS }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euo pipefail

            # Wait for apt lock to be available (max 5 minutes)
            echo "Waiting for apt lock..."
            for i in {1..30}; do
              if sudo fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; then
                echo "Apt is locked, waiting 10s... (attempt $i/30)"
                sleep 10
              else
                break
              fi
            done

            # Install only if not already present
            if ! command -v docker &> /dev/null; then
              echo "Installing Docker..."
              sudo apt-get update -y
              sudo apt-get install -y docker.io || { echo "Docker install failed"; exit 1; }
            fi

            if ! command -v git &> /dev/null; then
              echo "Installing Git..."
              sudo apt-get update -y
              sudo apt-get install -y git || { echo "Git install failed"; exit 1; }
            fi

            # Setup feat/pipeline branch directory
            if [ ! -d "networkdeg-pipeline" ]; then
              git clone -b feat/pipeline https://github.com/dhruvq/networkdeg.git networkdeg-pipeline
            fi

            cd networkdeg-pipeline
            git fetch origin
            git reset --hard origin/feat/pipeline

            # Stop & remove old container
            sudo docker stop netprophet-pipeline || true
            sudo docker rm netprophet-pipeline || true

            # Build new image
            sudo docker build -t netprophet-pipeline .

            # Run container on port 5001 (staging/testing)
            sudo docker run -d \
              --name netprophet-pipeline \
              --restart unless-stopped \
              -p 5001:5000 \
              netprophet-pipeline

            # Cleanup old images
            sudo docker image prune -f
