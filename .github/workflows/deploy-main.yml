name: Deploy Main Branch to Port 80

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Deploy Main to EC2 (Port 80)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST_DNS }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euo pipefail

            # Wait for apt lock to be available (max 5 minutes)
            echo "Waiting for apt lock..."
            for i in {1..30}; do
              if sudo fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; then
                echo "Apt is locked, waiting 10s... (attempt $i/30)"
                sleep 10
              else
                break
              fi
            done

            # Install only if not already present
            if ! command -v docker &> /dev/null; then
              echo "Installing Docker..."
              sudo apt-get update -y
              sudo apt-get install -y docker.io || { echo "Docker install failed"; exit 1; }
            fi

            if ! command -v git &> /dev/null; then
              echo "Installing Git..."
              sudo apt-get update -y
              sudo apt-get install -y git || { echo "Git install failed"; exit 1; }
            fi

            # Setup main branch directory
            if [ ! -d "networkdeg-main" ]; then
              git clone -b main https://github.com/dhruvq/networkdeg.git networkdeg-main
            fi

            cd networkdeg-main
            git fetch origin
            git reset --hard origin/main

            # Create persistent cache directory on host (survives deployments)
            sudo mkdir -p /var/lib/netprophet/cache

            # Stop & remove old container
            sudo docker stop netprophet-main || true
            sudo docker rm netprophet-main || true

            # Build new image
            sudo docker build -t netprophet-main .

            # Run container on port 80 with persistent cache volume
            sudo docker run -d \
              --name netprophet-main \
              --restart unless-stopped \
              -p 80:5000 \
              -v /var/lib/netprophet/cache:/tmp \
              netprophet-main

            # Wait for Flask to start
            echo "Waiting for Flask to start..."
            sleep 5

            # Verify deployment
            if curl -f http://localhost/ --max-time 10; then
              echo "Deployment successful - Flask is responding"
            else
              echo "Deployment failed - Flask not responding"
              sudo docker logs netprophet-main --tail 50
              exit 1
            fi

            # Setup cron job for cache updates (if not already configured)
            if ! crontab -l 2>/dev/null | grep -q "update_cache.py"; then
              echo "Setting up cron job for cache updates..."
              (crontab -l 2>/dev/null; echo "*/10 * * * * sudo docker exec netprophet-main python3 /app/update_cache.py >> /var/log/netprophet_cache.log 2>&1") | crontab -
              echo "Cron job configured"
            else
              echo "Cron job already configured"
            fi

            # Manually trigger initial cache update
            echo "Triggering initial cache update..."
            sudo docker exec netprophet-main python3 /app/update_cache.py || echo "Initial cache update will retry via cron"

            # Cleanup old images
            sudo docker image prune -f
